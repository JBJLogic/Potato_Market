{% extends "base.html" %}

{% block content %}
<style>
    .product-detail-container {
        padding: 2rem 0 4rem;
    }
    .product-detail-wrapper {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    .product-detail-header {
        display: grid;
        grid-template-columns: 1fr 1.2fr;
        gap: 2rem;
    }
    .product-detail-image {
        width: 100%;
        aspect-ratio: 1/1;
        border-radius: 16px;
        overflow: hidden;
        background: #f7f7f7;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .product-detail-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .product-detail-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .product-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }
    .product-detail-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }
    .product-detail-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: #8B4513;
    }
    .product-actions {
        display: flex;
        gap: 0.75rem;
    }
    .product-detail-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #555;
        font-size: 0.95rem;
    }
    .product-detail-description,
    .product-location,
    .product-comments {
        background: #fafafa;
        border-radius: 16px;
        padding: 1.5rem;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
    }
    .product-detail-description h3,
    .product-location h3,
    .product-comments h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 700;
    }
    .map-wrapper {
        margin: 1rem auto 0;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #eee;
        width: 100%;
        max-width: 800px;
        height: 300px;
        min-height: 300px;
        position: relative;
    }
    #detailMap {
        width: 100% !important;
        height: 100% !important;
        min-height: 300px;
        display: block;
    }
    .comment-form textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #ddd;
        padding: 1rem;
        resize: none;
        font-size: 1rem;
        transition: border 0.2s;
    }
    .comment-form textarea:focus {
        outline: none;
        border-color: #8B4513;
    }
    .comment-form button {
        margin-top: 0.75rem;
        width: 140px;
    }
    .comment-item {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid #f0f0f0;
        margin-bottom: 0.75rem;
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 0.5rem;
    }
    .comment-content {
        font-size: 1rem;
        color: #333;
        white-space: pre-line;
    }
    @media (max-width: 992px) {
        .product-detail-header {
            grid-template-columns: 1fr;
        }
        .product-actions {
            flex-direction: column;
        }
        .product-detail-title {
            font-size: 1.5rem;
        }
        .product-detail-price {
            font-size: 2rem;
        }
    }
</style>

<div class="product-detail-container">
    <div class="container">
        <div class="product-detail-wrapper">
            <div class="product-detail-header">
                <div class="product-detail-image">
                    {% if product.image_url %}
                        <img src="{{ product.image_url }}" alt="{{ product.title }}">
                    {% else %}
                        <div style="font-size: 4rem;">ğŸ“¦</div>
                    {% endif %}
                </div>
                <div class="product-detail-info">
                    <div class="product-title-row">
                        <h1 class="product-detail-title">{{ product.title }}</h1>
                        <div class="product-actions">
                            {% if product.is_sold %}
                                <div class="sold-status">ê±°ë˜ì™„ë£Œ</div>
                            {% else %}
                                <button class="btn btn-primary" onclick="showPurchaseModal()">
                                    êµ¬ë§¤í•˜ê¸°
                                </button>
                                <button class="btn btn-outline chat-btn" onclick="startChat()">
                                    <i class="fas fa-comments"></i> ì±„íŒ…í•˜ê¸°
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="product-detail-price">{{ "{:,}".format(product.price) }}ì›</div>
                    <div class="product-detail-meta">
                        <div class="meta-item">
                            <i class="fas fa-truck"></i>
                            <span>{{ product.delivery_method or 'ë°°ì†¡ ì •ë³´ ì—†ìŒ' }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>íŒë§¤ì: {{ product.seller_nickname }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>ë“±ë¡ì¼: {{ product.created_at_display or '-' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="product-detail-description">
                <h3>ìƒí’ˆ ì„¤ëª…</h3>
                <p>{{ product.description or 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.' }}</p>
            </div>

            <div class="product-location">
                <div class="map-wrapper">
                    <div id="detailMap"></div>
                </div>
            </div>

            <div class="product-comments">
                <h3>ìƒí’ˆ ë¬¸ì˜</h3>
                <form id="commentForm" class="comment-form">
                    <textarea id="commentText" rows="3" placeholder="ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..." required></textarea>
                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary">ë¬¸ì˜í•˜ê¸°</button>
                    </div>
                </form>
                <div id="commentsList" class="comments-list" style="margin-top: 1.5rem;">
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="comment-item">
                                <div class="comment-header">
                                    <span class="comment-user">{{ comment.user_nickname }}</span>
                                    <span class="comment-date">{{ comment.created_at_display }}</span>
                                </div>
                                <div class="comment-content">{{ comment.comment }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: #666;">ì•„ì§ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- êµ¬ë§¤ ëª¨ë‹¬ -->
<div id="purchaseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('purchaseModal')">&times;</span>
        <h2>êµ¬ë§¤í•˜ê¸°</h2>
        <div id="purchaseInfo"></div>
        <div class="purchase-actions">
            <button class="btn btn-outline" onclick="closeModal('purchaseModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="confirmPurchase()">êµ¬ë§¤í•˜ê¸°</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.PRODUCT_DATA = {{ product | tojson }};
</script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_api | default('') }}&libraries=services"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeProductDetailPage();
    });

    function initializeProductDetailPage() {
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', handleCommentSubmit);
        }
        waitForKakaoMaps(setupDetailMap);
    }

    function waitForKakaoMaps(callback, retries = 20) {
        if (typeof kakao !== 'undefined' && kakao.maps) {
            callback();
        } else if (retries > 0) {
            setTimeout(() => waitForKakaoMaps(callback, retries - 1), 200);
        } else {
            console.error('Kakao Maps SDK ë¡œë“œ ì‹¤íŒ¨');
        }
    }

    function setupDetailMap() {
        const mapContainer = document.getElementById('detailMap');
        if (!mapContainer || !window.PRODUCT_DATA) {
            console.error('ì§€ë„ ì»¨í…Œì´ë„ˆ ë˜ëŠ” ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const productData = window.PRODUCT_DATA;
        const baseAddress = productData.meeting_address || '';
        const detailAddress = productData.meeting_detail || '';
        const fullAddress = `${baseAddress} ${detailAddress}`.trim();

        if (!fullAddress) {
            mapContainer.innerHTML = '<p style="padding: 2rem; color: #666; text-align: center; font-size: 1.1rem;">ê±°ë˜ ì£¼ì†Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘, ì£¼ì†Œ:', fullAddress);

        // ì§€ë„ ì»¨í…Œì´ë„ˆ í¬ê¸° í™•ì¸
        console.log('ì§€ë„ ì»¨í…Œì´ë„ˆ í¬ê¸°:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
        
        // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };

        const map = new kakao.maps.Map(mapContainer, mapOption);
        
        // ì§€ë„ ìƒì„± í›„ relayout í˜¸ì¶œ
        setTimeout(function() {
            map.relayout();
            console.log('ì§€ë„ relayout ì™„ë£Œ');
        }, 100);

        // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        const geocoder = new kakao.maps.services.Geocoder();

        // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
        geocoder.addressSearch(fullAddress, function(result, status) {
            // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                console.log('ê²€ìƒ‰ëœ ì¢Œí‘œ:', coords);

                // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
                const marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
                const infowindow = new kakao.maps.InfoWindow({
                    content: `<div style="width:150px;text-align:center;padding:6px 0;">${productData.title || 'ê±°ë˜ ì¥ì†Œ'}</div>`
                });
                infowindow.open(map, marker);

                // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                map.setCenter(coords);
                
                // ì§€ë„ í¬ê¸° ì¬ì¡°ì •
                setTimeout(function() {
                    map.relayout();
                    console.log('ì§€ë„ í‘œì‹œ ì™„ë£Œ, ì¢Œí‘œ:', coords);
                }, 200);
            } else {
                console.error('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨:', status);
                mapContainer.innerHTML = '<p style="padding: 2rem; color: #666; text-align: center; font-size: 1.1rem;">ì£¼ì†Œë¥¼ ì§€ë„ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        });
    }

    function showPurchaseModal() {
        if (!window.currentUser) {
            showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }

        const purchaseModal = document.getElementById('purchaseModal');
        const purchaseInfo = document.getElementById('purchaseInfo');

        if (purchaseInfo) {
            purchaseInfo.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <h3>${PRODUCT_DATA.title}</h3>
                    <div style="font-size: 1.5rem; color: #8B4513; font-weight: bold; margin: 1rem 0;">
                        ${Number(PRODUCT_DATA.price).toLocaleString()}ì›
                    </div>
                    <p style="color: #666;">êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                </div>
            `;
        }

        purchaseModal.setAttribute('data-product-id', PRODUCT_DATA.id);
        purchaseModal.style.display = 'block';
    }

    async function confirmPurchase() {
        const purchaseModal = document.getElementById('purchaseModal');
        const productId = purchaseModal.getAttribute('data-product-id');

        if (!productId) {
            showNotification('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const response = await fetch('/api/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ product_id: parseInt(productId, 10) }),
                credentials: 'include'
            });

            const result = await response.json();
            if (response.ok) {
                showNotification('ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                closeModal('purchaseModal');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            } else {
                showNotification(result.error || 'êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('êµ¬ë§¤ ì˜¤ë¥˜:', error);
            showNotification('êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    async function handleCommentSubmit(event) {
        event.preventDefault();
        const commentText = document.getElementById('commentText');
        const comment = (commentText.value || '').trim();

        if (!comment) {
            showNotification('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (!window.currentUser) {
            showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    product_id: PRODUCT_DATA.id,
                    comment
                })
            });

            if (response.ok) {
                showNotification('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                commentText.value = '';
                await fetchComments();
            } else {
                const error = await response.json();
                showNotification(error.error || 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            console.error('ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:', error);
            showNotification('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    async function fetchComments() {
        try {
            const response = await fetch(`/api/comments/${PRODUCT_DATA.id}`);
            if (!response.ok) return;
            const result = await response.json();
            renderComments(result.comments || []);
        } catch (error) {
            console.error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        }
    }

    function renderComments(comments) {
        const commentsList = document.getElementById('commentsList');
        if (!commentsList) return;

        if (!comments.length) {
            commentsList.innerHTML = '<p style="text-align: center; color: #666;">ì•„ì§ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        commentsList.innerHTML = comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">${comment.user_nickname}</span>
                    <span class="comment-date">${formatKoreanDate(comment.created_at)}</span>
                </div>
                <div class="comment-content">${comment.comment}</div>
            </div>
        `).join('');
    }

    function formatKoreanDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString.replace(' ', 'T'));
        if (isNaN(date.getTime())) return dateString;
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ` +
               `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    async function startChat() {
        if (!window.currentUser) {
            showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/chat/room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ product_id: PRODUCT_DATA.id }),
                credentials: 'include'
            });

            if (response.ok) {
                const result = await response.json();
                window.location.href = `/chat/${result.room_id}`;
            } else {
                const error = await response.json();
                showNotification(error.error || 'ì±„íŒ…ë°©ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ì±„íŒ… ì‹œì‘ ì˜¤ë¥˜:', error);
            showNotification('ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
</script>
{% endblock %}
